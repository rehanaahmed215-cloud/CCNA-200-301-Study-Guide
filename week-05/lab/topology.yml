name: week05-intervlan

topology:
  nodes:
    # FRR router acting as inter-VLAN router (router-on-a-stick concept)
    router1:
      kind: linux
      image: frrouting/frr:latest
      binds:
        - router1_daemons:/etc/frr/daemons
      exec:
        # Enable IP forwarding
        - ip link set eth1 up
        - ip link set eth2 up
        # VLAN 10 on eth1 side
        - ip addr add 192.168.10.1/24 dev eth1
        # VLAN 20 on eth2 side
        - ip addr add 192.168.20.1/24 dev eth2
        - sysctl -w net.ipv4.ip_forward=1

    # Container simulating VLAN 10 switch
    switch-vlan10:
      kind: linux
      image: wbitt/network-multitool:latest
      exec:
        - ip link add br0 type bridge
        - ip link set br0 up
        - ip link set eth1 master br0
        - ip link set eth2 master br0
        - ip link set eth3 master br0

    # Container simulating VLAN 20 switch
    switch-vlan20:
      kind: linux
      image: wbitt/network-multitool:latest
      exec:
        - ip link add br0 type bridge
        - ip link set br0 up
        - ip link set eth1 master br0
        - ip link set eth2 master br0
        - ip link set eth3 master br0

    # Host in VLAN 10
    pc1:
      kind: linux
      image: wbitt/network-multitool:latest
      exec:
        - ip addr flush dev eth1
        - ip addr add 192.168.10.10/24 dev eth1
        - ip route add default via 192.168.10.1

    # Host in VLAN 10
    pc2:
      kind: linux
      image: wbitt/network-multitool:latest
      exec:
        - ip addr flush dev eth1
        - ip addr add 192.168.10.20/24 dev eth1
        - ip route add default via 192.168.10.1

    # Host in VLAN 20
    pc3:
      kind: linux
      image: wbitt/network-multitool:latest
      exec:
        - ip addr flush dev eth1
        - ip addr add 192.168.20.10/24 dev eth1
        - ip route add default via 192.168.20.1

    # Host in VLAN 20
    pc4:
      kind: linux
      image: wbitt/network-multitool:latest
      exec:
        - ip addr flush dev eth1
        - ip addr add 192.168.20.20/24 dev eth1
        - ip route add default via 192.168.20.1

  links:
    # Router connects to both "VLANs" (bridges)
    - endpoints: ["router1:eth1", "switch-vlan10:eth1"]
    - endpoints: ["router1:eth2", "switch-vlan20:eth1"]
    # PCs in VLAN 10
    - endpoints: ["pc1:eth1", "switch-vlan10:eth2"]
    - endpoints: ["pc2:eth1", "switch-vlan10:eth3"]
    # PCs in VLAN 20
    - endpoints: ["pc3:eth1", "switch-vlan20:eth2"]
    - endpoints: ["pc4:eth1", "switch-vlan20:eth3"]
