#!/bin/bash
# lab — helper to connect to running Containerlab nodes
# Usage:
#   lab ls              List all running lab containers
#   lab <node>          Open a shell in a container (fuzzy match)
#   lab <node> <cmd>    Run a command in a container
#   lab --all           Open a new Terminal tab for each container
#   lab destroy         Tear down the lab in the current directory

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
RED='\033[0;31m'
BOLD='\033[1m'
NC='\033[0m'

# ---------- helpers ----------
list_containers() {
    docker ps --filter "label=clab-node-name" --format "{{.Names}}" 2>/dev/null | sort
}

short_name() {
    # clab-week01-pc1 → pc1
    echo "$1" | sed 's/^clab-[^-]*-//'
}

resolve_container() {
    local query="$1"
    local matches

    # Exact full name match
    if docker inspect "$query" &>/dev/null; then
        echo "$query"
        return 0
    fi

    # Match by short name (node name) — suffix match
    matches=$(list_containers | grep -i -- "$query" || true)
    local count
    count=$(echo "$matches" | grep -c . 2>/dev/null || echo 0)

    if [[ "$count" -eq 1 ]]; then
        echo "$matches"
        return 0
    elif [[ "$count" -gt 1 ]]; then
        echo -e "${YELLOW}Multiple matches for '$query':${NC}" >&2
        echo "$matches" | while read -r c; do
            echo "  $(short_name "$c")  →  $c" >&2
        done
        echo -e "${YELLOW}Be more specific.${NC}" >&2
        return 1
    else
        echo -e "${RED}No running container matching '$query'${NC}" >&2
        echo "Run '${BOLD}lab ls${NC}' to see available nodes." >&2
        return 1
    fi
}

detect_shell() {
    local ctr="$1"
    if docker exec "$ctr" test -x /bin/bash 2>/dev/null; then
        echo "/bin/bash"
    elif docker exec "$ctr" test -x /usr/bin/vtysh 2>/dev/null; then
        echo "/usr/bin/vtysh"
    else
        echo "/bin/sh"
    fi
}

# ---------- commands ----------
cmd_list() {
    local containers
    containers=$(list_containers)
    if [[ -z "$containers" ]]; then
        echo -e "${YELLOW}No lab containers running.${NC}"
        echo "Deploy a lab first:  cd week-XX/lab && containerlab deploy -t topology.yml"
        return 1
    fi

    echo -e "${BOLD}Running lab nodes:${NC}"
    echo ""
    printf "  ${BOLD}%-25s  %-35s  %s${NC}\n" "NODE" "CONTAINER" "IMAGE"
    echo "  ---------------------------------------------------------------"
    echo "$containers" | while read -r c; do
        local img
        img=$(docker inspect --format '{{.Config.Image}}' "$c" 2>/dev/null)
        printf "  ${CYAN}%-25s${NC}  %-35s  %s\n" "$(short_name "$c")" "$c" "$img"
    done
    echo ""
    echo -e "Connect: ${GREEN}lab <node>${NC}    Example: ${GREEN}lab pc1${NC}"
}

cmd_connect() {
    local query="$1"
    shift
    local ctr
    ctr=$(resolve_container "$query") || return 1

    if [[ $# -gt 0 ]]; then
        # Run a specific command
        docker exec -it "$ctr" "$@"
    else
        # Open interactive shell
        local shell
        shell=$(detect_shell "$ctr")
        echo -e "${GREEN}Connecting to $(short_name "$ctr") ($ctr) — $shell${NC}"
        docker exec -it "$ctr" "$shell"
    fi
}

cmd_open_all() {
    local containers
    containers=$(list_containers)
    if [[ -z "$containers" ]]; then
        echo -e "${YELLOW}No lab containers running.${NC}"
        return 1
    fi

    echo -e "${BOLD}Opening a Terminal tab for each node...${NC}"
    echo "$containers" | while read -r c; do
        local name
        name=$(short_name "$c")
        local shell
        shell=$(detect_shell "$c")
        osascript -e "
            tell application \"Terminal\"
                activate
                do script \"echo 'Connected to $name'; docker exec -it $c $shell\"
            end tell
        " &>/dev/null
        echo -e "  ${GREEN}✓${NC} $name"
    done
    echo ""
    echo "All tabs opened in Terminal.app"
}

cmd_destroy() {
    if [[ -f topology.yml ]]; then
        containerlab destroy -t topology.yml
    else
        echo -e "${RED}No topology.yml in current directory.${NC}"
        echo "cd into a week's lab/ folder first."
        return 1
    fi
}

# ---------- main ----------
case "${1:-}" in
    ls|list)
        cmd_list
        ;;
    --all|all)
        cmd_open_all
        ;;
    destroy|down)
        cmd_destroy
        ;;
    -h|--help|help|"")
        echo ""
        echo -e "${BOLD}lab${NC} — Containerlab node connector"
        echo ""
        echo "Usage:"
        echo -e "  ${GREEN}lab ls${NC}              List all running lab containers"
        echo -e "  ${GREEN}lab <node>${NC}          Open a shell on a node (fuzzy match)"
        echo -e "  ${GREEN}lab <node> <cmd>${NC}    Run a command on a node"
        echo -e "  ${GREEN}lab --all${NC}           Open a Terminal tab for every node"
        echo -e "  ${GREEN}lab destroy${NC}         Tear down the lab in the current dir"
        echo ""
        echo "Examples:"
        echo -e "  ${CYAN}lab pc1${NC}                  → shell into pc1"
        echo -e "  ${CYAN}lab router1${NC}              → shell into router1 (drops into vtysh if FRR)"
        echo -e "  ${CYAN}lab pc1 ping 192.168.1.1${NC} → run a single command"
        echo -e "  ${CYAN}lab --all${NC}                → open all nodes in separate Terminal tabs"
        echo ""
        ;;
    *)
        cmd_connect "$@"
        ;;
esac
